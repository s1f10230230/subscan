# å®Ÿè£…è¨ˆç”»æ›¸

## 1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦ãƒ»é–‹ç™ºæˆ¦ç•¥

### 1.1 é–‹ç™ºæ–¹é‡
- **MVP-First Approach**: æœ€å°é™ã®æ©Ÿèƒ½ã§ä¾¡å€¤å®Ÿè¨¼å¾Œã€æ®µéšçš„æ©Ÿèƒ½æ‹¡å¼µ
- **Claude Codeæ´»ç”¨**: å„Phaseæ¯ã«è©³ç´°ãªå®Ÿè£…æŒ‡ç¤ºæ›¸ã‚’ä½œæˆ
- **å‹å®‰å…¨æ€§é‡è¦–**: TypeScript + Zod + Prismaã§å …ç‰¢ãªè¨­è¨ˆ
- **ãƒ†ã‚¹ãƒˆé§†å‹•**: é‡è¦æ©Ÿèƒ½ã¯å…ˆã«ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
- **ãƒ‡ãƒ—ãƒ­ã‚¤æœ€å„ªå…ˆ**: å„Phaseå®Œäº†å¾Œã™ãã«Vercelãƒ‡ãƒ—ãƒ­ã‚¤ãƒ»æ¤œè¨¼

### 1.2 é–‹ç™ºç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
```bash
# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
npx create-next-app@latest cardsync --typescript --tailwind --eslint --app

# å¿…é ˆãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
npm install prisma @prisma/client next-auth @next-auth/prisma-adapter
npm install zod react-hook-form @hookform/resolvers stripe
npm install @upstash/redis @upstash/ratelimit swr
npm install lucide-react recharts date-fns
npm install @radix-ui/react-dialog @radix-ui/react-dropdown-menu
npm install class-variance-authority clsx tailwind-merge

# é–‹ç™ºç”¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸
npm install -D @types/node tsx
```

### 1.3 ç’°å¢ƒå¤‰æ•°è¨­å®šï¼ˆ.env.localï¼‰
```env
# Database
DATABASE_URL="postgresql://..."
DIRECT_URL="postgresql://..."

# NextAuth
NEXTAUTH_URL="http://localhost:3000"
NEXTAUTH_SECRET="your-secret-key"

# Google OAuth
GOOGLE_CLIENT_ID="your-google-client-id"
GOOGLE_CLIENT_SECRET="your-google-client-secret"

# Gmail API
GMAIL_API_KEY="your-gmail-api-key"

# Stripe
STRIPE_PUBLISHABLE_KEY="pk_test_..."
STRIPE_SECRET_KEY="sk_test_..."
STRIPE_WEBHOOK_SECRET="whsec_..."

# Redis (Upstash)
UPSTASH_REDIS_REST_URL="https://..."
UPSTASH_REDIS_REST_TOKEN="..."

# Encryption
ENCRYPTION_KEY="32-character-key-for-email-tokens"
```

## 2. Phaseåˆ¥å®Ÿè£…è¨ˆç”»

### Phase 1: åŸºç›¤æ§‹ç¯‰ âš™ï¸ï¼ˆæ¨å®š2-3é€±é–“ï¼‰

#### 1.1 ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆæœŸè¨­å®š
**å®Ÿè£…é †åº:**
1. **Prismaã‚¹ã‚­ãƒ¼ãƒè¨­å®š**
   - `prisma/schema.prisma` ä½œæˆ
   - åˆæœŸãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
   - ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚«ãƒ†ã‚´ãƒªã€ã‚µãƒ–ã‚¹ã‚¯ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰

2. **å…±é€šãƒ©ã‚¤ãƒ–ãƒ©ãƒªæ§‹ç¯‰**
   - `lib/prisma.ts` - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶š
   - `lib/auth.ts` - NextAuthè¨­å®š
   - `lib/utils.ts` - æ±ç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼
   - `lib/validations.ts` - Zodã‚¹ã‚­ãƒ¼ãƒ
   - `lib/encryption.ts` - æš—å·åŒ–ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£

3. **å‹å®šç¾©ãƒ»ã‚¤ãƒ³ã‚¿ãƒ¼faces**
   - `types/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå…¨ä½“
   - API ãƒ¬ã‚¹ãƒãƒ³ã‚¹å‹
   - ãƒ•ã‚©ãƒ¼ãƒ å‹å®šç¾©

**Claude CodeæŒ‡ç¤ºä¾‹:**
```
Phase 1ã®Prismaã‚¹ã‚­ãƒ¼ãƒã¨NextAuthè¨­å®šã‚’å®Ÿè£…ã—ã¦ãã ã•ã„ã€‚

è¦ä»¶:
1. æä¾›ã—ãŸãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆã«åŸºã¥ãPrisma schema
2. Google OAuthå¯¾å¿œã®NextAuthè¨­å®š
3. å‹å®‰å…¨ãªPrisma Clientè¨­å®š
4. ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚«ãƒ†ã‚´ãƒªãƒ»ã‚µãƒ–ã‚¹ã‚¯ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿

æŠ€è¡“ä»•æ§˜:
- Next.js 14 App Router
- Prisma ORM
- NextAuth.js v5
- TypeScript strict mode

ãƒ•ã‚¡ã‚¤ãƒ«:
- prisma/schema.prisma
- lib/auth.ts
- lib/prisma.ts
- prisma/seed.ts
```

#### 1.2 èªè¨¼ã‚·ã‚¹ãƒ†ãƒ 
**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«:**
```
app/api/auth/[...nextauth]/route.ts    # NextAuthè¨­å®š
app/(auth)/login/page.tsx               # ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢
app/(auth)/signup/page.tsx              # ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ç”»é¢
components/auth/LoginForm.tsx           # ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ 
components/auth/SocialLogin.tsx         # ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ãƒ­ã‚°ã‚¤ãƒ³
middleware.ts                           # èªè¨¼ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
```

#### 1.3 UIåŸºç›¤ãƒ»ãƒ‡ã‚¶ã‚¤ãƒ³ã‚·ã‚¹ãƒ†ãƒ 
**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«:**
```
components/ui/                          # shadcn/ui ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
â”œâ”€â”€ Button.tsx
â”œâ”€â”€ Input.tsx
â”œâ”€â”€ Card.tsx
â”œâ”€â”€ Dialog.tsx
â””â”€â”€ Toast.tsx

styles/globals.css                      # Tailwindè¨­å®š
lib/cn.ts                              # ã‚¯ãƒ©ã‚¹åãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
```

**Phase 1å®Œäº†æ¡ä»¶:**
- [ ] ãƒ­ã‚°ã‚¤ãƒ³ãƒ»ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‹•ä½œç¢ºèª
- [ ] ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ»åŸºæœ¬CRUDå‹•ä½œ
- [ ] Vercelåˆå›ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸ
- [ ] å‹å®‰å…¨æ€§ç¢ºèªï¼ˆTypeScriptã‚¨ãƒ©ãƒ¼0ï¼‰

### Phase 2: ã‚³ã‚¢æ©Ÿèƒ½å®Ÿè£… ğŸ—ï¸ï¼ˆæ¨å®š3-4é€±é–“ï¼‰

#### 2.1 ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ãƒ»è¨­å®š
**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«:**
```
app/api/users/profile/route.ts          # ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«API
app/(dashboard)/settings/page.tsx       # è¨­å®šç”»é¢
components/settings/ProfileForm.tsx     # ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†
components/settings/PreferencesForm.tsx # ç’°å¢ƒè¨­å®š
hooks/useAuth.ts                        # èªè¨¼ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯
```

#### 2.2 ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ç®¡ç†
**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«:**
```
app/api/cards/route.ts                  # ã‚«ãƒ¼ãƒ‰ç®¡ç†API
app/api/cards/[id]/route.ts             # å€‹åˆ¥ã‚«ãƒ¼ãƒ‰API
app/(dashboard)/cards/page.tsx          # ã‚«ãƒ¼ãƒ‰ä¸€è¦§ç”»é¢
app/(dashboard)/cards/[id]/page.tsx     # ã‚«ãƒ¼ãƒ‰è©³ç´°ç”»é¢
components/cards/CardList.tsx           # ã‚«ãƒ¼ãƒ‰ä¸€è¦§ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
components/cards/CardForm.tsx           # ã‚«ãƒ¼ãƒ‰è¿½åŠ ãƒ»ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ 
components/cards/CardDetail.tsx         # ã‚«ãƒ¼ãƒ‰è©³ç´°è¡¨ç¤º
```

#### 2.3 å–å¼•ç®¡ç†ï¼ˆæ‰‹å‹•å…¥åŠ›ï¼‰
**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«:**
```
app/api/transactions/route.ts           # å–å¼•ç®¡ç†API
app/api/transactions/[id]/route.ts      # å€‹åˆ¥å–å¼•API
app/(dashboard)/transactions/page.tsx   # å–å¼•ä¸€è¦§ç”»é¢
components/transactions/TransactionList.tsx    # å–å¼•ä¸€è¦§
components/transactions/TransactionForm.tsx    # å–å¼•è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ 
components/transactions/TransactionCard.tsx    # å–å¼•ã‚«ãƒ¼ãƒ‰
components/transactions/CategorySelector.tsx   # ã‚«ãƒ†ã‚´ãƒªé¸æŠ
hooks/useTransactions.ts                # å–å¼•ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯
```

**Phase 2å®Œäº†æ¡ä»¶:**
- [ ] ã‚«ãƒ¼ãƒ‰ç™»éŒ²ãƒ»ç·¨é›†ãƒ»å‰Šé™¤å‹•ä½œ
- [ ] æ‰‹å‹•å–å¼•å…¥åŠ›ãƒ»ä¸€è¦§è¡¨ç¤ºå‹•ä½œ
- [ ] ã‚«ãƒ†ã‚´ãƒªåˆ†é¡æ©Ÿèƒ½å‹•ä½œ
- [ ] ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ç¢ºèª

### Phase 3: å·®åˆ¥åŒ–æ©Ÿèƒ½ï¼ˆãƒ¡ãƒ¼ãƒ«é€£æºï¼‰ğŸš€ï¼ˆæ¨å®š4-5é€±é–“ï¼‰

#### 3.1 ãƒ¡ãƒ¼ãƒ«é€£æºåŸºç›¤
**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«:**
```
app/api/email/accounts/route.ts         # ãƒ¡ãƒ¼ãƒ«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç®¡ç†
app/api/email/sync/route.ts             # ãƒ¡ãƒ¼ãƒ«åŒæœŸAPI
app/api/email/logs/route.ts             # å‡¦ç†ãƒ­ã‚°API
lib/email/gmail.ts                      # Gmail APIé€£æº
lib/email/parser.ts                     # ãƒ¡ãƒ¼ãƒ«è§£æã‚¨ãƒ³ã‚¸ãƒ³
lib/email/patterns.ts                   # ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°
lib/background-jobs.ts                  # ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†
components/email/ConnectionForm.tsx     # ãƒ¡ãƒ¼ãƒ«é€£æºãƒ•ã‚©ãƒ¼ãƒ 
components/email/SyncStatus.tsx         # åŒæœŸçŠ¶æ³è¡¨ç¤º
components/email/LogViewer.tsx          # ãƒ­ã‚°è¡¨ç¤º
```

#### 3.2 ã‚ªãƒ³ãƒœãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆWOWä½“é¨“ï¼‰
**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«:**
```
app/(dashboard)/onboarding/page.tsx     # ã‚ªãƒ³ãƒœãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒˆãƒƒãƒ—
app/(dashboard)/onboarding/[step]/page.tsx  # ã‚¹ãƒ†ãƒƒãƒ—æ¯ç”»é¢
components/onboarding/WelcomeScreen.tsx     # ã‚¦ã‚§ãƒ«ã‚«ãƒ ç”»é¢
components/onboarding/EmailConnection.tsx  # ãƒ¡ãƒ¼ãƒ«é€£æº
components/onboarding/AnalysisProgress.tsx # åˆ†æãƒ—ãƒ­ã‚°ãƒ¬ã‚¹
components/onboarding/ResultsScreen.tsx    # çµæœè¡¨ç¤º
components/onboarding/PlanSelection.tsx    # ãƒ—ãƒ©ãƒ³é¸æŠ
hooks/useOnboarding.ts                  # ã‚ªãƒ³ãƒœãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ç®¡ç†
```

#### 3.3 ãƒ¡ãƒ¼ãƒ«è§£æã‚¨ãƒ³ã‚¸ãƒ³
**å®Ÿè£…è©³ç´°:**
```typescript
// lib/email/parser.ts ã®ä¸»è¦æ©Ÿèƒ½

1. Gmail APIé€£æº
   - OAuth2èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†
   - ãƒ¡ãƒ¼ãƒ«æ¤œç´¢ãƒ»å–å¾—
   - ãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾å¿œ

2. ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°
   - ã‚¯ãƒ¬ã‚«ä¼šç¤¾åˆ¥ãƒ‘ã‚¿ãƒ¼ãƒ³
   - ã‚µãƒ–ã‚¹ã‚¯ã‚µãƒ¼ãƒ“ã‚¹åˆ¥ãƒ‘ã‚¿ãƒ¼ãƒ³
   - æ­£è¦è¡¨ç¾ + æ©Ÿæ¢°å­¦ç¿’çš„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ

3. ãƒ‡ãƒ¼ã‚¿æŠ½å‡º
   - é‡‘é¡ãƒ»é€šè²¨æŠ½å‡º
   - åº—èˆ—åãƒ»ã‚µãƒ¼ãƒ“ã‚¹åæŠ½å‡º
   - æ—¥ä»˜æ­£è¦åŒ–

4. ä¿¡é ¼åº¦ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°
   - ãƒ‘ã‚¿ãƒ¼ãƒ³ä¸€è‡´åº¦
   - ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å­¦ç¿’
```

**Claude CodeæŒ‡ç¤ºä¾‹:**
```
Phase 3ã®Gmail APIé€£æºã¨ãƒ¡ãƒ¼ãƒ«è§£ææ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¦ãã ã•ã„ã€‚

è¦ä»¶:
1. Gmail OAuth2èªè¨¼ã¨ãƒ¡ãƒ¼ãƒ«å–å¾—
2. ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰åˆ©ç”¨é€šçŸ¥ã®è‡ªå‹•æ¤œå‡º
3. Netflixã€Spotifyç­‰ã®ã‚µãƒ–ã‚¹ã‚¯æ¤œçŸ¥
4. æ®µéšçš„å‡¦ç†ã§Vercelåˆ¶é™å›é¿
5. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨ãƒ­ã‚°è¨˜éŒ²

æŠ€è¡“ä»•æ§˜:
- Gmail API v1
- OAuth2 PKCE flow
- æ­£è¦è¡¨ç¾ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°
- ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†ï¼ˆ15ç§’åˆ¶é™å¯¾å¿œï¼‰
- ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼å¯¾å¿œ

å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«:
- lib/email/gmail.ts
- lib/email/parser.ts
- lib/email/patterns.ts
- app/api/email/sync/route.ts
```

**Phase 3å®Œäº†æ¡ä»¶:**
- [ ] Gmailé€£æºãƒ»ãƒ¡ãƒ¼ãƒ«å–å¾—å‹•ä½œ
- [ ] ä¸»è¦ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆNetflixã€æ¥½å¤©ã‚«ãƒ¼ãƒ‰ç­‰ï¼‰ã®æ¤œçŸ¥ç²¾åº¦80%ä»¥ä¸Š
- [ ] ã‚ªãƒ³ãƒœãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã€Œ3åˆ†å®Œäº†ã€ä½“é¨“å®Ÿç¾
- [ ] ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ãƒ»ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½å®Œå‚™

### Phase 4: ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç®¡ç† ğŸ’°ï¼ˆæ¨å®š2-3é€±é–“ï¼‰

#### 4.1 ã‚µãƒ–ã‚¹ã‚¯æ¤œçŸ¥ãƒ»ç®¡ç†
**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«:**
```
app/api/subscriptions/route.ts          # ã‚µãƒ–ã‚¹ã‚¯ç®¡ç†API
app/api/subscriptions/detect/route.ts   # è‡ªå‹•æ¤œçŸ¥API
app/api/subscriptions/analytics/route.ts # ç¯€ç´„åˆ†æAPI
app/(dashboard)/subscriptions/page.tsx  # ã‚µãƒ–ã‚¹ã‚¯ç®¡ç†ç”»é¢
components/subscriptions/SubscriptionList.tsx  # ã‚µãƒ–ã‚¹ã‚¯ä¸€è¦§
components/subscriptions/SubscriptionCard.tsx  # ã‚µãƒ–ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰
components/subscriptions/DetectedAlert.tsx     # æ¤œçŸ¥ã‚¢ãƒ©ãƒ¼ãƒˆ
components/subscriptions/SavingsCalculator.tsx # ç¯€ç´„è¨ˆç®—æ©Ÿ
```

#### 4.2 ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰çµ±è¨ˆ
**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«:**
```
app/api/dashboard/stats/route.ts        # ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰çµ±è¨ˆAPI
app/(dashboard)/page.tsx                # ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”»é¢
components/dashboard/StatsCard.tsx      # çµ±è¨ˆã‚«ãƒ¼ãƒ‰
components/dashboard/ExpenseChart.tsx   # æ”¯å‡ºãƒãƒ£ãƒ¼ãƒˆ
components/dashboard/RecentTransactions.tsx # æœ€æ–°å–å¼•
components/dashboard/SubscriptionAlert.tsx  # ã‚µãƒ–ã‚¹ã‚¯ã‚¢ãƒ©ãƒ¼ãƒˆ
hooks/useDashboard.ts                   # ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ•ãƒƒã‚¯
```

**Phase 4å®Œäº†æ¡ä»¶:**
- [ ] ã‚µãƒ–ã‚¹ã‚¯è‡ªå‹•æ¤œçŸ¥ãƒ»æ‰‹å‹•ç®¡ç†æ©Ÿèƒ½
- [ ] ç¯€ç´„å¯èƒ½é¡è¨ˆç®—ãƒ»è¡¨ç¤ºæ©Ÿèƒ½
- [ ] ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰çµ±è¨ˆè¡¨ç¤º
- [ ] ã‚¢ãƒ©ãƒ¼ãƒˆãƒ»é€šçŸ¥æ©Ÿèƒ½

### Phase 5: èª²é‡‘ãƒ»é‹ç”¨æ©Ÿèƒ½ ğŸ’³ï¼ˆæ¨å®š2-3é€±é–“ï¼‰

#### 5.1 Stripeèª²é‡‘ã‚·ã‚¹ãƒ†ãƒ 
**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«:**
```
app/api/webhooks/stripe/route.ts        # Stripe Webhook
app/api/users/subscription/route.ts     # ãƒ—ãƒ©ãƒ³ç®¡ç†API
app/(dashboard)/pricing/page.tsx        # æ–™é‡‘ãƒ—ãƒ©ãƒ³ç”»é¢
app/(dashboard)/billing/page.tsx        # èª²é‡‘ç®¡ç†ç”»é¢
components/pricing/PricingTable.tsx     # æ–™é‡‘è¡¨
components/billing/BillingHistory.tsx   # èª²é‡‘å±¥æ­´
lib/stripe.ts                          # Stripeè¨­å®š
```

#### 5.2 é‹ç”¨ãƒ»ç›£è¦–æ©Ÿèƒ½
**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«:**
```
app/api/admin/stats/route.ts           # ç®¡ç†è€…çµ±è¨ˆAPI
app/(admin)/dashboard/page.tsx         # ç®¡ç†è€…ç”»é¢
components/admin/UserStats.tsx         # ãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±è¨ˆ
components/admin/SystemHealth.tsx      # ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³
lib/monitoring.ts                      # ç›£è¦–ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆ
```

**Phase 5å®Œäº†æ¡ä»¶:**
- [ ] 3ã¤ã®ãƒ—ãƒ©ãƒ³ï¼ˆFree/Standard/Proï¼‰èª²é‡‘å‹•ä½œ
- [ ] ãƒ—ãƒ©ãƒ³åˆ¶é™ãƒ»æ©Ÿèƒ½åˆ¶å¾¡
- [ ] ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
- [ ] ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆ

## 3. æŠ€è¡“å®Ÿè£…è©³ç´°

### 3.1 é‡è¦æ©Ÿèƒ½ã®å®Ÿè£…æ–¹é‡

#### Gmail APIé€£æº
```typescript
// lib/email/gmail.ts å®Ÿè£…æ–¹é‡

class GmailService {
  // OAuth2ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†
  async refreshAccessToken(refreshToken: string): Promise<string>
  
  // ãƒ¡ãƒ¼ãƒ«æ¤œç´¢ãƒ»å–å¾—ï¼ˆãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œï¼‰
  async searchEmails(query: string, maxResults: number): Promise<EmailMessage[]>
  
  // ãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾å¿œ
  async withRateLimit<T>(fn: () => Promise<T>): Promise<T>
  
  // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
  async handleGmailError(error: any): Promise<void>
}

// æ¤œç´¢ã‚¯ã‚¨ãƒªä¾‹
const buildSearchQuery = (dateRange: DateRange) => {
  const senders = [
    'noreply@account.netflix.com',
    'account-update@amazon.co.jp', 
    'rakuten-card.co.jp'
  ].join(' OR from:');
  
  return `from:(${senders}) after:${formatDate(dateRange.start)}`;
};
```

#### ãƒ¡ãƒ¼ãƒ«è§£æã‚¨ãƒ³ã‚¸ãƒ³
```typescript
// lib/email/parser.ts å®Ÿè£…æ–¹é‡

interface ExtractionResult {
  success: boolean;
  confidence: number; // 0.0 - 1.0
  data?: {
    amount: number;
    currency: string;
    merchantName: string;
    serviceType: 'SUBSCRIPTION' | 'TRANSACTION';
  };
  errors: string[];
}

class EmailParser {
  // ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°
  async extractFromEmail(email: EmailMessage): Promise<ExtractionResult>
  
  // æ®µéšçš„æ¤œè¨¼
  async validateExtraction(result: ExtractionResult): Promise<boolean>
  
  // å­¦ç¿’ãƒ»æ”¹å–„
  async learnFromCorrection(original: ExtractionResult, corrected: any): Promise<void>
}
```

#### ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†ï¼ˆVercelå¯¾å¿œï¼‰
```typescript
// lib/background-jobs.ts å®Ÿè£…æ–¹é‡

class BackgroundJobManager {
  // æ®µéšçš„å‡¦ç†ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå›é¿
  async processInBatches<T>(
    items: T[], 
    batchSize: number,
    processor: (batch: T[]) => Promise<any>
  ): Promise<void>
  
  // å‡¦ç†ç¶™ç¶šã®ãŸã‚ã®æ¬¡å›ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
  async scheduleNextBatch(jobId: string, startIndex: number): Promise<void>
  
  // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ç®¡ç†
  async updateProgress(jobId: string, progress: number): Promise<void>
}
```

### 3.2 ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

#### ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥
```typescript
// Redis ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‘ã‚¿ãƒ¼ãƒ³
const CACHE_KEYS = {
  USER_PROFILE: (userId: string) => `user:${userId}:profile`,
  DASHBOARD_STATS: (userId: string) => `dashboard:${userId}:stats`,
  TRANSACTIONS: (userId: string, page: number) => `transactions:${userId}:${page}`,
  SUBSCRIPTIONS: (userId: string) => `subscriptions:${userId}`
};

const CACHE_TTL = {
  USER_PROFILE: 300,      // 5åˆ†
  DASHBOARD_STATS: 60,    // 1åˆ†  
  TRANSACTIONS: 30,       // 30ç§’
  SUBSCRIPTIONS: 300      // 5åˆ†
};
```

#### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æœ€é©åŒ–
```sql
-- é‡è¦ãªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_transactions_user_date ON transactions(user_id, transaction_date DESC);
CREATE INDEX idx_email_data_account_received ON email_data(email_account_id, received_at DESC);
CREATE INDEX idx_subscriptions_user_status ON subscriptions(user_id, status);
```

### 3.3 ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ»ãƒ­ã‚°æˆ¦ç•¥

#### çµ±ä¸€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
```typescript
// lib/error-handler.ts
export class AppError extends Error {
  constructor(
    public code: string,
    message: string,
    public statusCode: number = 500,
    public isOperational: boolean = true
  ) {
    super(message);
  }
}

// ã‚¨ãƒ©ãƒ¼åˆ†é¡
export const ERROR_CODES = {
  // èªè¨¼é–¢é€£
  UNAUTHORIZED: 'UNAUTHORIZED',
  FORBIDDEN: 'FORBIDDEN',
  
  // ãƒ‡ãƒ¼ã‚¿é–¢é€£  
  NOT_FOUND: 'NOT_FOUND',
  VALIDATION_ERROR: 'VALIDATION_ERROR',
  DUPLICATE_ENTRY: 'DUPLICATE_ENTRY',
  
  // å¤–éƒ¨APIé–¢é€£
  GMAIL_API_ERROR: 'GMAIL_API_ERROR',
  RATE_LIMIT_EXCEEDED: 'RATE_LIMIT_EXCEEDED',
  
  // å‡¦ç†é–¢é€£
  EMAIL_PARSING_FAILED: 'EMAIL_PARSING_FAILED',
  BACKGROUND_JOB_FAILED: 'BACKGROUND_JOB_FAILED'
} as const;
```

## 4. ãƒ†ã‚¹ãƒˆæˆ¦ç•¥

### 4.1 ãƒ†ã‚¹ãƒˆåˆ†é¡ãƒ»å„ªå…ˆåº¦

#### å˜ä½“ãƒ†ã‚¹ãƒˆï¼ˆé«˜å„ªå…ˆåº¦ï¼‰
```typescript
// __tests__/lib/email/parser.test.ts
describe('EmailParser', () => {
  test('Netflix subscription detection', async () => {
    const mockEmail = {
      subject: 'Netflix - ãŠæ”¯æ‰•ã„ã®ãŠçŸ¥ã‚‰ã›',
      sender: 'noreply@account.netflix.com',
      body: 'æœˆé¡ãƒ—ãƒ©ãƒ³ Â¥1,490ã®æ”¯æ‰•ã„ãŒå®Œäº†ã—ã¾ã—ãŸ'
    };
    
    const result = await parser.extractFromEmail(mockEmail);
    
    expect(result.success).toBe(true);
    expect(result.confidence).toBeGreaterThan(0.9);
    expect(result.data?.amount).toBe(1490);
    expect(result.data?.serviceType).toBe('SUBSCRIPTION');
  });
});
```

#### çµ±åˆãƒ†ã‚¹ãƒˆï¼ˆä¸­å„ªå…ˆåº¦ï¼‰  
```typescript
// __tests__/api/email/sync.test.ts
describe('/api/email/sync', () => {
  test('Gmail sync with real email data', async () => {
    // ãƒ†ã‚¹ãƒˆç”¨ã®Gmailã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½¿ç”¨
    const response = await request(app)
      .post('/api/email/sync')
      .set('Authorization', `Bearer ${testToken}`)
      .send({ accountId: testAccountId });
      
    expect(response.status).toBe(200);
    expect(response.body.success).toBe(true);
  });
});
```

#### E2Eãƒ†ã‚¹ãƒˆï¼ˆä½å„ªå…ˆåº¦ï¼‰
```typescript
// e2e/onboarding.spec.ts - Playwrightä½¿ç”¨
test('onboarding flow completes successfully', async ({ page }) => {
  await page.goto('/onboarding');
  await page.click('text=Gmailã§å§‹ã‚ã‚‹');
  // Gmail OAuth flow simulation
  await page.waitForSelector('[data-testid=analysis-progress]');
  await page.waitForSelector('[data-testid=results-screen]', { timeout: 180000 });
  
  expect(await page.textContent('[data-testid=subscriptions-found]')).toContain('å€‹ã®ã‚µãƒ–ã‚¹ã‚¯ã‚’ç™ºè¦‹');
});
```

### 4.2 ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ãƒ»ãƒ¢ãƒƒã‚¯æˆ¦ç•¥

#### ãƒ¡ãƒ¼ãƒ«ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿
```typescript
// __tests__/__fixtures__/email-samples.ts
export const NETFLIX_EMAIL = {
  messageId: 'netflix-test-001',
  subject: 'Netflix - ãŠæ”¯æ‰•ã„ã®ãŠçŸ¥ã‚‰ã›',
  sender: 'noreply@account.netflix.com',
  receivedAt: new Date('2024-01-15T10:00:00Z'),
  body: `
    Netflixãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³ã®æœˆé¡æ–™é‡‘Â¥1,490ã®ãŠæ”¯æ‰•ã„ãŒå®Œäº†ã„ãŸã—ã¾ã—ãŸã€‚
    æ¬¡å›ã®ãŠæ”¯æ‰•ã„äºˆå®šæ—¥: 2024å¹´2æœˆ15æ—¥
  `
};

export const RAKUTEN_CARD_EMAIL = {
  messageId: 'rakuten-test-001', 
  subject: 'ã€æ¥½å¤©ã‚«ãƒ¼ãƒ‰ã€‘ã”åˆ©ç”¨ã®ãŠçŸ¥ã‚‰ã›',
  sender: 'info@mail.rakuten-card.co.jp',
  receivedAt: new Date('2024-01-16T14:30:00Z'),
  body: `
    ã”åˆ©ç”¨æ—¥æ™‚: 2024/01/16 14:25
    ã”åˆ©ç”¨åº—èˆ—: Amazon.co.jp
    ã”åˆ©ç”¨é‡‘é¡: 2,480å††
  `
};
```

## 5. ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãƒ»CI/CD

### 5.1 Vercelãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®š
```json
// vercel.json
{
  "framework": "nextjs",
  "buildCommand": "npm run build",
  "devCommand": "npm run dev",
  "installCommand": "npm install",
  "functions": {
    "app/api/**/*.ts": {
      "maxDuration": 30
    }
  },
  "env": {
    "DATABASE_URL": "@database-url",
    "NEXTAUTH_SECRET": "@nextauth-secret"
  }
}
```

### 5.2 GitHub Actions CI/CD
```yaml
# .github/workflows/deploy.yml
name: Deploy to Vercel

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      - run: npm ci
      - run: npm run test
      - run: npm run type-check
      
  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      - uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.ORG_ID }}
          vercel-project-id: ${{ secrets.PROJECT_ID }}
          vercel-args: '--prod'
```

## 6. é‹ç”¨ãƒ»ç›£è¦–è¨ˆç”»

### 6.1 ç›£è¦–é …ç›®
- **ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³**: ã‚¨ãƒ©ãƒ¼ç‡ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“
- **ã‚¤ãƒ³ãƒ•ãƒ©**: Vercel Functionå®Ÿè¡Œæ™‚é–“ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶š
- **ãƒ“ã‚¸ãƒã‚¹**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²æ•°ã€ãƒ¡ãƒ¼ãƒ«åŒæœŸæˆåŠŸç‡ã€èª²é‡‘è»¢æ›ç‡
- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: ç•°å¸¸ãƒ­ã‚°ã‚¤ãƒ³æ¤œçŸ¥ã€APIä¸æ­£åˆ©ç”¨

### 6.2 ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š
```typescript
// lib/monitoring.ts
export const ALERT_THRESHOLDS = {
  EMAIL_SYNC_ERROR_RATE: 0.2,      // 20%ä»¥ä¸Š
  API_RESPONSE_TIME: 3000,         // 3ç§’ä»¥ä¸Š
  GMAIL_API_QUOTA_USAGE: 0.8,      // 80%ä»¥ä¸Š
  DATABASE_CONNECTION_ERROR: 1     // 1ä»¶ã§ã‚‚
};
```

## 7. Claude Codeå®Ÿè£…æŒ‡ç¤ºãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ

### 7.1 Phaseåˆ¥å®Ÿè£…æŒ‡ç¤º
```markdown
## Phase [N]: [ãƒ•ã‚§ãƒ¼ã‚ºå] å®Ÿè£…æŒ‡ç¤º

### æ¦‚è¦
[ã“ã®Phaseã§å®Ÿè£…ã™ã‚‹æ©Ÿèƒ½ã®æ¦‚è¦]

### è¦ä»¶
1. [æ©Ÿèƒ½è¦ä»¶1]
2. [æ©Ÿèƒ½è¦ä»¶2] 
3. [éæ©Ÿèƒ½è¦ä»¶1]

### æŠ€è¡“ä»•æ§˜
- Framework: Next.js 14 App Router
- Database: PostgreSQL + Prisma
- Authentication: NextAuth.js
- UI: Tailwind CSS + shadcn/ui
- Validation: Zod

### å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«
```
[ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹1]
[ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹2]
```

### å®Ÿè£…é †åº
1. [ã‚¿ã‚¹ã‚¯1] - [æ¨å®šæ™‚é–“]
2. [ã‚¿ã‚¹ã‚¯2] - [æ¨å®šæ™‚é–“]

### ãƒ†ã‚¹ãƒˆè¦ä»¶
- [ ] [ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1]
- [ ] [ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹2]

### å®Œäº†æ¡ä»¶
- [ ] [æ¡ä»¶1]
- [ ] [æ¡ä»¶2]
```

## 8. ãƒªã‚¹ã‚¯ç®¡ç†ãƒ»å¯¾ç­–

### 8.1 æŠ€è¡“ãƒªã‚¹ã‚¯
| ãƒªã‚¹ã‚¯ | å½±éŸ¿åº¦ | å¯¾ç­– |
|--------|--------|------|
| Gmail APIåˆ¶é™ | é«˜ | ãƒ¬ãƒ¼ãƒˆåˆ¶é™å®Ÿè£…ã€è¤‡æ•°ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå¯¾å¿œ |
| ãƒ¡ãƒ¼ãƒ«è§£æç²¾åº¦ | é«˜ | ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿å……å®Ÿã€æ®µéšçš„æ”¹å–„ |
| Vercelåˆ¶é™ | ä¸­ | ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†æœ€é©åŒ– |
| ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è² è· | ä¸­ | ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æœ€é©åŒ–ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ´»ç”¨ |

### 8.2 ãƒ“ã‚¸ãƒã‚¹ãƒªã‚¹ã‚¯  
| ãƒªã‚¹ã‚¯ | å½±éŸ¿åº¦ | å¯¾ç­– |
|--------|--------|------|
| ç«¶åˆå‚å…¥ | ä¸­ | å·®åˆ¥åŒ–æ©Ÿèƒ½ã®å¼·åŒ–ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“å‘ä¸Š |
| æ³•è¦åˆ¶å¤‰æ›´ | ä½ | ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼æ•´å‚™ã€GDPRå¯¾å¿œ |
| èª²é‡‘ã‚·ã‚¹ãƒ†ãƒ éšœå®³ | é«˜ | Stripeå†—é•·åŒ–ã€éšœå®³æ™‚å¯¾å¿œãƒ•ãƒ­ãƒ¼ |

---

ã“ã®å®Ÿè£…è¨ˆç”»æ›¸ã«ã‚ˆã‚Šã€Claude Codeã‚’ä½¿ã£ãŸæ®µéšçš„ã§ç¢ºå®Ÿãªé–‹ç™ºãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚å„Phaseã®å®Œäº†å¾Œã«ã¯ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ»ãƒ†ã‚¹ãƒˆã‚’è¡Œã„ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’åé›†ã—ãªãŒã‚‰æ¬¡ã®Phaseã«é€²ã‚€æˆ¦ç•¥ã§ã™ã€‚

å®Ÿè£…ã‚’é–‹å§‹ã—ã¾ã™ã‹ï¼Ÿãã‚Œã¨ã‚‚è¨ˆç”»ã«ã¤ã„ã¦èª¿æ•´ã—ãŸã„ç‚¹ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ