# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆæ›¸

## 1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¦‚è¦

**ä½¿ç”¨æŠ€è¡“ï¼š** PostgreSQL + Prisma ORM
**ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆï¼š** Vercel PostgreSQL

## 2. ERå›³æ¦‚è¦

```
User (1) ---- (N) CreditCard
User (1) ---- (N) EmailAccount  
User (1) ---- (N) Transaction
User (1) ---- (N) Subscription
User (1) ---- (N) Category

Transaction (N) ---- (1) Category
Transaction (N) ---- (1) CreditCard
Subscription (N) ---- (1) User
EmailData (N) ---- (1) EmailAccount
```

## 3. ãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆ

### 3.1 Userï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰
```sql
CREATE TABLE users (
  id                String      PRIMARY KEY DEFAULT cuid()
  email            String      UNIQUE NOT NULL
  name             String?
  image            String?
  provider         String      NOT NULL -- 'google', 'yahoo'
  provider_id      String      NOT NULL
  plan             PlanType    DEFAULT 'FREE' -- 'FREE', 'STANDARD', 'PRO'
  subscription_id  String?     -- Stripe subscription ID
  month_start_day  Int         DEFAULT 1 -- æœˆã®é–‹å§‹æ—¥ï¼ˆ1-28ï¼‰
  timezone         String      DEFAULT 'Asia/Tokyo'
  created_at       DateTime    DEFAULT now()
  updated_at       DateTime    updatedAt
  deleted_at       DateTime?
)
```

### 3.2 EmailAccountï¼ˆãƒ¡ãƒ¼ãƒ«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼‰
```sql
CREATE TABLE email_accounts (
  id              String    PRIMARY KEY DEFAULT cuid()
  user_id         String    NOT NULL REFERENCES users(id) ON DELETE CASCADE
  email_address   String    NOT NULL
  provider        String    NOT NULL -- 'gmail', 'yahoo'
  access_token    String    NOT NULL -- æš—å·åŒ–å¿…é ˆ
  refresh_token   String?   -- æš—å·åŒ–å¿…é ˆ
  token_expires   DateTime?
  is_active       Boolean   DEFAULT true
  last_sync       DateTime?
  created_at      DateTime  DEFAULT now()
  updated_at      DateTime  updatedAt
  
  UNIQUE(user_id, email_address)
)
```

### 3.3 CreditCardï¼ˆã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ï¼‰
```sql
CREATE TABLE credit_cards (
  id           String      PRIMARY KEY DEFAULT cuid()
  user_id      String      NOT NULL REFERENCES users(id) ON DELETE CASCADE
  name         String      NOT NULL -- 'ãƒ¡ã‚¤ãƒ³ã‚«ãƒ¼ãƒ‰', 'æ¥½å¤©ã‚«ãƒ¼ãƒ‰'
  brand        String      NOT NULL -- 'VISA', 'MasterCard', 'JCB'
  issuer       String      NOT NULL -- 'æ¥½å¤©', 'ä¸‰äº•ä½å‹', 'JCB'
  last_digits  String      NOT NULL -- ä¸‹4æ¡
  color        String      DEFAULT '#3B82F6' -- UIè¡¨ç¤ºç”¨
  is_active    Boolean     DEFAULT true
  created_at   DateTime    DEFAULT now()
  updated_at   DateTime    updatedAt
  
  UNIQUE(user_id, issuer, last_digits)
)
```

### 3.4 Categoryï¼ˆã‚«ãƒ†ã‚´ãƒªï¼‰
```sql
CREATE TABLE categories (
  id          String    PRIMARY KEY DEFAULT cuid()
  user_id     String?   REFERENCES users(id) ON DELETE CASCADE -- NULLã®å ´åˆã‚·ã‚¹ãƒ†ãƒ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
  name        String    NOT NULL
  icon        String    DEFAULT 'ğŸ’³'
  color       String    DEFAULT '#6B7280'
  is_default  Boolean   DEFAULT false
  sort_order  Int       DEFAULT 0
  created_at  DateTime  DEFAULT now()
  updated_at  DateTime  updatedAt
  
  UNIQUE(user_id, name)
)

-- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚«ãƒ†ã‚´ãƒªã®INSERT
INSERT INTO categories (name, icon, color, is_default) VALUES
('é£Ÿè²»', 'ğŸ½ï¸', '#EF4444', true),
('äº¤é€šè²»', 'ğŸšƒ', '#3B82F6', true),
('ã‚¨ãƒ³ã‚¿ãƒ¡', 'ğŸ¬', '#8B5CF6', true),
('ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³', 'ğŸ’³', '#F59E0B', true),
('ç”Ÿæ´»è²»', 'ğŸ ', '#10B981', true),
('åŒ»ç™‚è²»', 'ğŸ¥', '#EC4899', true),
('ãã®ä»–', 'ğŸ“¦', '#6B7280', true);
```

### 3.5 Transactionï¼ˆå–å¼•å±¥æ­´ï¼‰
```sql
CREATE TABLE transactions (
  id              String       PRIMARY KEY DEFAULT cuid()
  user_id         String       NOT NULL REFERENCES users(id) ON DELETE CASCADE
  credit_card_id  String       NOT NULL REFERENCES credit_cards(id) ON DELETE CASCADE
  category_id     String       NOT NULL REFERENCES categories(id)
  amount          Int          NOT NULL -- å††å˜ä½ã§ä¿å­˜
  currency        String       DEFAULT 'JPY'
  exchange_rate   Decimal(10,4)? -- å¤–è²¨ã®å ´åˆã®ãƒ¬ãƒ¼ãƒˆ
  merchant_name   String       NOT NULL -- åº—èˆ—å
  description     String?      -- ãƒ¡ãƒ¢
  transaction_date DateTime    NOT NULL -- å–å¼•æ—¥
  source          SourceType   DEFAULT 'MANUAL' -- 'EMAIL', 'MANUAL'
  email_data_id   String?      REFERENCES email_data(id)
  is_verified     Boolean      DEFAULT false -- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç¢ºèªæ¸ˆã¿ã‹
  created_at      DateTime     DEFAULT now()
  updated_at      DateTime     updatedAt
  
  INDEX(user_id, transaction_date)
  INDEX(credit_card_id, transaction_date)
)
```

### 3.6 Subscriptionï¼ˆã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
```sql
CREATE TABLE subscriptions (
  id                String         PRIMARY KEY DEFAULT cuid()
  user_id           String         NOT NULL REFERENCES users(id) ON DELETE CASCADE
  credit_card_id    String?        REFERENCES credit_cards(id)
  service_name      String         NOT NULL -- 'Netflix', 'Spotify'
  plan_name         String?        -- 'Premium', 'Family'
  amount            Int            NOT NULL -- å††å˜ä½
  currency          String         DEFAULT 'JPY'
  billing_cycle     BillingCycle   NOT NULL -- 'MONTHLY', 'YEARLY'
  next_billing_date DateTime?
  status            SubStatus      DEFAULT 'ACTIVE' -- 'ACTIVE', 'CANCELED', 'PAUSED'
  detection_method  DetectionType  DEFAULT 'AUTO' -- 'AUTO', 'MANUAL'
  confidence_score  Decimal(3,2)?  -- è‡ªå‹•æ¤œå‡ºã®ä¿¡é ¼åº¦ï¼ˆ0.00-1.00ï¼‰
  usage_memo        String?        -- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¨˜å…¥ã™ã‚‹åˆ©ç”¨çŠ¶æ³
  last_transaction_id String?      REFERENCES transactions(id)
  created_at        DateTime       DEFAULT now()
  updated_at        DateTime       updatedAt
  
  INDEX(user_id, status)
  INDEX(next_billing_date)
)
```

### 3.7 EmailDataï¼ˆãƒ¡ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ï¼‰
```sql
CREATE TABLE email_data (
  id                String    PRIMARY KEY DEFAULT cuid()
  email_account_id  String    NOT NULL REFERENCES email_accounts(id) ON DELETE CASCADE
  message_id        String    NOT NULL -- ãƒ¡ãƒ¼ãƒ«ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ID
  subject           String    NOT NULL
  sender            String    NOT NULL
  received_at       DateTime  NOT NULL
  extracted_amount  Int?      -- æŠ½å‡ºã—ãŸé‡‘é¡ï¼ˆå††å˜ä½ï¼‰
  extracted_currency String?  -- æŠ½å‡ºã—ãŸé€šè²¨ã‚³ãƒ¼ãƒ‰
  merchant_name     String?   -- æŠ½å‡ºã—ãŸåº—èˆ—å
  processed         Boolean   DEFAULT false
  processed_at      DateTime?
  created_at        DateTime  DEFAULT now()
  
  UNIQUE(email_account_id, message_id)
  INDEX(email_account_id, received_at)
)

-- æ³¨æ„: æœ¬æ–‡ã¯è§£ææ™‚ã®ã¿ä½¿ç”¨ã—ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã¯ä¿å­˜ã—ãªã„
-- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ä¿è­·ã®ãŸã‚
```

### 3.8 SubscriptionPatternï¼ˆã‚µãƒ–ã‚¹ã‚¯æ¤œå‡ºãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
```sql
CREATE TABLE subscription_patterns (
  id            String    PRIMARY KEY DEFAULT cuid()
  service_name  String    NOT NULL
  sender_pattern String   NOT NULL -- æ­£è¦è¡¨ç¾
  subject_pattern String  NOT NULL -- æ­£è¦è¡¨ç¾
  amount_pattern String?  -- é‡‘é¡æŠ½å‡ºç”¨æ­£è¦è¡¨ç¾
  currency      String    DEFAULT 'JPY'
  billing_cycle BillingCycle DEFAULT 'MONTHLY'
  confidence    Decimal(3,2) DEFAULT 0.90 -- ã“ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ä¿¡é ¼åº¦
  is_active     Boolean   DEFAULT true
  created_at    DateTime  DEFAULT now()
  updated_at    DateTime  updatedAt
  
  UNIQUE(service_name, sender_pattern)
)

-- åˆæœŸãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ‡ãƒ¼ã‚¿
INSERT INTO subscription_patterns (service_name, sender_pattern, subject_pattern, amount_pattern) VALUES
('Netflix', 'noreply@account\.netflix\.com', 'ãŠæ”¯æ‰•ã„ã®ãŠçŸ¥ã‚‰ã›|Payment confirmation', 'Â¥?([0-9,]+)'),
('Spotify', 'noreply@spotify\.com', 'Premium|ãŠæ”¯æ‰•ã„', '\$([0-9.]+)|Â¥([0-9,]+)'),
('Amazon Prime', 'account-update@amazon\.co\.jp', 'ãƒ—ãƒ©ã‚¤ãƒ ä¼šå“¡|Prime membership', 'Â¥([0-9,]+)'),
('Adobe Creative Cloud', 'message\.adobe\.com', 'Creative Cloud|ãŠæ”¯æ‰•ã„å®Œäº†', 'Â¥([0-9,]+)|\$([0-9.]+)');
```

## 4. Enumå®šç¾©

```typescript
enum PlanType {
  FREE
  STANDARD  
  PRO
}

enum SourceType {
  EMAIL
  MANUAL
}

enum BillingCycle {
  MONTHLY
  YEARLY
  WEEKLY
}

enum SubStatus {
  ACTIVE
  CANCELED
  PAUSED
}

enum DetectionType {
  AUTO
  MANUAL
}
```

## 5. ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨­è¨ˆ

### 5.1 ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹é‡è¦–ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
- `transactions`: (user_id, transaction_date DESC)
- `subscriptions`: (user_id, status, next_billing_date)
- `email_data`: (email_account_id, received_at DESC)

### 5.2 è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
- `transactions`: (user_id, category_id, transaction_date)
- `subscriptions`: (user_id, credit_card_id, status)

### 5.9 UserActivityLogï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãƒ­ã‚°ï¼‰
```sql
CREATE TABLE user_activity_logs (
  id          String      PRIMARY KEY DEFAULT cuid()
  user_id     String      NOT NULL REFERENCES users(id) ON DELETE CASCADE
  action      String      NOT NULL -- 'login', 'email_sync', 'transaction_add'
  details     Json?       -- è¿½åŠ è©³ç´°æƒ…å ±
  ip_address  String?
  user_agent  String?
  created_at  DateTime    DEFAULT now()
  
  INDEX(user_id, created_at)
)
```

### 5.10 EmailProcessingErrorï¼ˆãƒ¡ãƒ¼ãƒ«è§£æã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ï¼‰
```sql
CREATE TABLE email_processing_errors (
  id              String    PRIMARY KEY DEFAULT cuid()
  email_data_id   String    NOT NULL REFERENCES email_data(id) ON DELETE CASCADE
  error_type      String    NOT NULL -- 'AMOUNT_EXTRACTION_FAILED', 'MERCHANT_PARSING_FAILED'
  error_message   String    NOT NULL
  email_subject   String    NOT NULL -- ãƒ‡ãƒãƒƒã‚°ç”¨
  email_sender    String    NOT NULL -- ãƒ‡ãƒãƒƒã‚°ç”¨
  created_at      DateTime  DEFAULT now()
  
  INDEX(error_type, created_at)
)
```

### 5.11 StripeWebhookLogï¼ˆèª²é‡‘å±¥æ­´ï¼‰
```sql
CREATE TABLE stripe_webhook_logs (
  id               String    PRIMARY KEY DEFAULT cuid()
  stripe_event_id  String    NOT NULL UNIQUE
  event_type       String    NOT NULL -- 'customer.subscription.created'
  user_id          String?   REFERENCES users(id) ON DELETE SET NULL
  processed        Boolean   DEFAULT false
  data             Json      NOT NULL -- Stripeã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿
  created_at       DateTime  DEFAULT now()
  
  INDEX(event_type, created_at)
  INDEX(user_id, created_at)
)
```

### 6.1 æš—å·åŒ–ãŒå¿…è¦ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
- `email_accounts.access_token`
- `email_accounts.refresh_token` 

### 6.2 ãƒ‡ãƒ¼ã‚¿å‡¦ç†ãƒ•ãƒ­ãƒ¼
- **ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡**: APIå–å¾—æ™‚ã®ã¿ä½¿ç”¨ã€è§£æå¾Œã¯ç ´æ£„
- **æŠ½å‡ºãƒ‡ãƒ¼ã‚¿**: é‡‘é¡ãƒ»é€šè²¨ãƒ»åº—èˆ—åã®ã¿ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¿å­˜
- **ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼**: ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ã®æ°¸ç¶šåŒ–ã¯è¡Œã‚ãªã„

### 6.2 ãƒ‡ãƒ¼ã‚¿ä¿æŒãƒãƒªã‚·ãƒ¼
- **ç„¡æ–™ç‰ˆ**: æ‰‹å‹•å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã¯æ°¸ç¶šä¿å­˜ã€ãƒ¡ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ãªã—
- **æœ‰æ–™ç‰ˆ**: ãƒ¡ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿3ãƒ¶æœˆä¿æŒ
- **Proç‰ˆ**: ãƒ¡ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿1å¹´ä¿æŒ
- **é€€ä¼šæ™‚**: 30æ—¥å¾Œã«å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤

## 7. Prismaã‚¹ã‚­ãƒ¼ãƒã‚µãƒ³ãƒ—ãƒ«

```prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String         @id @default(cuid())
  email           String         @unique
  name            String?
  image           String?
  provider        String
  providerId      String         @map("provider_id")
  plan            PlanType       @default(FREE)
  subscriptionId  String?        @map("subscription_id")
  monthStartDay   Int            @default(1) @map("month_start_day")
  timezone        String         @default("Asia/Tokyo")
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")
  deletedAt       DateTime?      @map("deleted_at")
  
  creditCards     CreditCard[]
  emailAccounts   EmailAccount[]
  transactions    Transaction[]
  subscriptions   Subscription[]
  categories      Category[]
  
  @@map("users")
}

enum PlanType {
  FREE
  STANDARD
  PRO
}

enum SourceType {
  EMAIL
  MANUAL
}

enum BillingCycle {
  MONTHLY
  YEARLY
  WEEKLY
}

enum SubStatus {
  ACTIVE
  CANCELED
  PAUSED
}

enum DetectionType {
  AUTO
  MANUAL
}
```

---

ã“ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆã§å•é¡Œãªã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚ç‰¹ã«ï¼š
1. ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹æˆã®éä¸è¶³
2. å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã®å¦¥å½“æ€§
3. ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨­è¨ˆã®é©åˆ‡æ€§
4. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶ã®å……è¶³æ€§

